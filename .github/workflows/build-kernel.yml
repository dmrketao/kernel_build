name: Build MikaKernel

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          # Reading variables from config.env and making them available to the shell
          cat config.env | while read line; do
            if [[ ! -z "$line" && "$line" != "#"* ]]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done

      - name: Pull toolchain
        run: |
          # Use Clang 12 (r416183b) for better 4.19 compatibility
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
          mkdir clang && curl -L https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r416183b.tar.gz -o clang.tar.gz
          tar -C clang/ -xf clang.tar.gz

      - name: Pull kernel source
        run: |
          # Using $VAR syntax for bash steps
          git clone --depth=1 $KERNEL_SOURCE -b $KERNEL_SOURCE_BRANCH kernel-source

      - name: Integrate SukiSU-Ultra & SUSFS
        run: |
          cd kernel-source
          # 1. Pull SukiSU-Ultra (susfs-main branch)
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          
          # 2. Apply SUSFS Patches (Kernel 4.19)
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.19 ../susfs
          cp ../susfs/kernel_patches/fs/susfs.c fs/
          cp ../susfs/kernel_patches/include/linux/susfs.h include/linux/
          
          # Patch core and ksu
          patch -p1 < ../susfs/kernel_patches/50_add_susfs_in_kernel-4.19.patch
          cd drivers/kernelsu && patch -p1 < ../../../susfs/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch && cd ../..

      - name: Inject Config Flags
        run: |
          cd kernel-source
          # Force KSU and SUSFS into your specific defconfig
          echo "CONFIG_KSU=y" >> arch/arm64/configs/$KERNEL_CONFIG
          echo "CONFIG_KSU_ULTRA=y" >> arch/arm64/configs/$KERNEL_CONFIG
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/$KERNEL_CONFIG
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> arch/arm64/configs/$KERNEL_CONFIG
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> arch/arm64/configs/$KERNEL_CONFIG

      - name: Build kernel
        run: |
          export KBUILD_BUILD_USER="zclkkk"
          export KBUILD_BUILD_HOST="workspace"
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/aarch64-linux-android-4.9/bin:$PATH
          
          args="ARCH=arm64 \
                O=../out \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=aarch64-linux-android- \
                CROSS_COMPILE_ARM32=arm-linux-androideabi- "
          
          cd kernel-source
          make ${args} $KERNEL_CONFIG
          make -j$(nproc) ${args} CC=clang

      - name: Package kernel
        run: |
          git clone --depth=1 $ANYKERNEL_SOURCE -b $ANYKERNEL_SOURCE_BRANCH AnyKernel3
          rm -rf AnyKernel3/.git AnyKernel3/.github
          
          # Move the compiled Image to AnyKernel folder
          if [[ -f out/arch/arm64/boot/Image.gz-dtb ]]; then
            cp out/arch/arm64/boot/Image.gz-dtb AnyKernel3/Image.gz-dtb
          elif [[ -f out/arch/arm64/boot/Image.gz ]]; then
            cp out/arch/arm64/boot/Image.gz AnyKernel3/Image.gz
          fi

      - name: Upload kernel to artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Ultra-Kernel
          path: AnyKernel3/*
